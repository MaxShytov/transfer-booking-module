# Task Definition: Dispatcher Dashboard

## Original Request
Создать для нового сотрудника рабочее место, в котором он будет управлять всеми процессами трансферов.

---

## Clarifying Questions & Answers

| Вопрос | Ответ |
|--------|-------|
| **Роль сотрудника** | Универсальная: диспетчер + оператор + менеджер |
| **Просмотр и фильтрация бронирований** | ✅ Да |
| **Назначение водителей на трансферы** | ✅ Да |
| **Изменение статусов бронирований** | ✅ Да |
| **Общение с клиентами/водителями** | ✅ Да |
| **Обработка отмен и возвратов** | ✅ Да |
| **Просмотр аналитики** | ✅ Да |
| **Платформа** | iPad приложение (Flutter) |
| **Текущая ситуация** | Django Admin |
| **Интеграции** | Пока не нужны |
| **Количество пользователей** | 1 сотрудник |

---

## Similar Implementations (Benchmarks)

### В текущем проекте

| Компонент | Расположение | Что можно использовать |
|-----------|--------------|------------------------|
| **Django Admin для Booking** | `backend/apps/bookings/admin.py` | Полная конфигурация BookingAdmin с фильтрами, поиском, fieldsets |
| **Sales Report Dashboard** | `backend/dashboard/sales_report.py` | Streamlit dashboard с KPI, графиками, фильтрами, экспортом |
| **Модель Booking** | `backend/apps/bookings/models.py` | Все поля бронирования, статусы, ценообразование |
| **Система ролей** | `backend/apps/accounts/models.py` | User model с ролями: ADMIN, MANAGER, DRIVER, CUSTOMER |

### Industry Best Practices (2025)

По данным [DesignRush](https://www.designrush.com/agency/ui-ux-design/dashboard/trends/dashboard-ux), [UXPin](https://www.uxpin.com/studio/blog/dashboard-design-principles/) и [Transfervista](https://transfervista.com/the-best-limousine-booking-software/):

| Принцип | Применение |
|---------|------------|
| **User-Centered Design** | Dashboard заточен под задачи диспетчера, не перегружен |
| **Prioritize Key Metrics** | Главные KPI на первом экране: сегодняшние трансферы, статусы, срочные |
| **Real-Time Data** | Автообновление статусов без перезагрузки страницы |
| **Contextual Insights** | Цветовая индикация статусов, сроков, проблем |
| **Consistency** | Единый стиль компонентов, предсказуемое поведение |
| **Calendar/Timeline View** | Визуализация трансферов на временной шкале |

### Конкуренты (Reference)

- **Transfervista** - управление бронированиями, платежами, расписанием из одного dashboard
- **Moovs** - управление бронированиями, оптимизация маршрутов, связь с водителями

---

## Refined Task Description

### Task Title
**Dispatcher App: iPad-приложение диспетчера для управления трансферами**

### Description
Создать iPad-приложение на Flutter, где диспетчер может управлять всеми аспектами трансферного бизнеса: просматривать бронирования, назначать водителей, менять статусы, обрабатывать отмены и видеть аналитику. Приложение будет использовать существующий backend API.

### Use Cases

| # | Роль | Действие | Цель |
|---|------|----------|------|
| 1 | Диспетчер | Открывает приложение в любое время | Видит все трансферы на сегодня с временем и статусами |
| 2 | Диспетчер | Фильтрует по дате/статусу | Находит нужные бронирования |
| 3 | Диспетчер | Назначает водителя на трансфер | Водитель получает задание |
| 4 | Диспетчер | Меняет статус на "В пути" | Клиент видит обновление |
| 5 | Диспетчер | Отменяет бронирование | Система обрабатывает возврат |
| 6 | Диспетчер | Просматривает аналитику | Видит KPI за период |
| 7 | Диспетчер | Создаёт бронирование вручную | Для телефонных заказов |
| 8 | Диспетчер | Редактирует детали бронирования | Исправляет ошибки или обновляет данные |

### Scope

#### ✅ In Scope (MVP)

**Основной функционал:**
- [ ] Таблица всех бронирований с фильтрами (дата, статус, оплата, класс машины)
- [ ] Быстрое изменение статуса бронирования (pending → confirmed → in_progress → completed)
- [ ] Назначение водителя на бронирование (новое поле driver в модели)
- [ ] Детальный просмотр бронирования со всей информацией
- [ ] Создание нового бронирования вручную
- [ ] Редактирование существующего бронирования
- [ ] Отмена бронирования с причиной

**Dashboard & Аналитика:**
- [ ] KPI панель: сегодняшние трансферы, выручка, статистика по статусам
- [ ] Календарный вид трансферов (опционально)
- [ ] Фильтры по периоду

**Технические требования:**
- [ ] Авторизация (только для роли MANAGER/ADMIN)
- [ ] Оптимизация под iPad (landscape и portrait режимы)
- [ ] Быстрый поиск по reference, имени, телефону
- [ ] Offline-режим для просмотра (опционально)

#### ❌ Out of Scope (не в этой задаче)

- Push-уведомления клиентам/водителям
- Интеграция с мессенджерами (WhatsApp, Telegram)
- GPS-трекинг водителей в реальном времени
- Мобильное приложение для диспетчера
- Интеграция с платёжными системами
- Автоматическое назначение водителей
- Многопользовательский режим с конфликтами

### Success Criteria

| # | Критерий | Метрика |
|---|----------|---------|
| 1 | Диспетчер может просмотреть все бронирования на день | Фильтр работает корректно |
| 2 | Изменение статуса занимает < 3 клика | UX проверен |
| 3 | Назначение водителя занимает < 5 секунд | Dropdown с водителями |
| 4 | Dashboard загружается < 3 секунд | Performance |
| 5 | Диспетчер может создать бронирование без Flutter app | Форма создания работает |
| 6 | KPI отображаются корректно | Сверка с базой данных |

### Technical Considerations

| Аспект | Рекомендация |
|--------|--------------|
| **Платформа** | Flutter iPad app (единый стек с существующим клиентским приложением) |
| **База данных** | Новое поле `driver` (FK на User с role=DRIVER) в модели Booking |
| **Аутентификация** | Использовать существующую JWT систему |
| **State Management** | Riverpod (как в основном приложении) |
| **UI Framework** | Cupertino widgets для нативного iPad look & feel |
| **Layout** | Master-Detail pattern для iPad (список слева, детали справа) |

---

## Complexity Assessment

| Параметр | Значение |
|----------|----------|
| **Complexity** | **Medium-High** |
| **Risk Level** | Medium |

### Risk Factors

| Риск | Вероятность | Митигация |
|------|-------------|-----------|
| **Scope creep** | Высокая | Строгий MVP, фиксированный scope |
| **UX сложность** | Средняя | Прототип в Figma перед разработкой |
| **Интеграция с существующими API** | Низкая | API уже есть, нужны доработки |
| **Выбор технологии** | Средняя | Streamlit для MVP, миграция на React позже |

---

## Components to Modify

### Django Backend

| Тип | Компонент | Изменения |
|-----|-----------|-----------|
| **Models** | `Booking` | Добавить поля: `assigned_driver`, `cancelled_at`, `cancellation_reason` |
| **Models** | Новый `Driver` или использовать `User` | Профиль водителя с контактами, машиной |
| **Views** | Новый `BookingAdminViewSet` | CRUD для диспетчера с расширенными permissions |
| **Serializers** | `BookingAdminSerializer` | Полный сериализатор для редактирования |
| **URLs** | `api/v1/admin/bookings/` | Новые endpoints для диспетчера |
| **Permissions** | `IsDispatcher` | Проверка роли MANAGER/ADMIN |

### Flutter iPad App

| Компонент | Описание |
|-----------|----------|
| **Dispatcher Home Screen** | Master-Detail layout: список слева, детали справа |
| **Booking List View** | Список с фильтрами, поиском, pull-to-refresh |
| **Booking Detail View** | Все поля бронирования, история изменений |
| **Booking Edit Screen** | Форма редактирования всех полей |
| **Booking Create Screen** | Создание нового бронирования |
| **Driver Picker** | Bottom sheet с доступными водителями |
| **Status Action Buttons** | Быстрые кнопки смены статуса |
| **KPI Dashboard Tab** | Метрики и графики (fl_chart) |
| **Calendar View Tab** | Календарь трансферов (table_calendar) |

### Новые провайдеры (Riverpod)

| Provider | Описание |
|----------|----------|
| `dispatcherBookingsProvider` | Список всех бронирований с фильтрами |
| `bookingDetailProvider` | Детали конкретного бронирования |
| `driversProvider` | Список доступных водителей |
| `dispatcherStatsProvider` | KPI и статистика |
| `bookingFiltersProvider` | Состояние фильтров |

### Database Migrations

```python
# Новые поля в Booking
assigned_driver = ForeignKey(User, null=True, related_name='assigned_bookings')
cancelled_at = DateTimeField(null=True)
cancellation_reason = TextField(blank=True)
dispatcher_notes = TextField(blank=True)  # внутренние заметки

# Возможно новая модель DriverProfile
class DriverProfile(models.Model):
    user = OneToOneField(User)
    phone = CharField()
    vehicle_plate = CharField()
    vehicle_class = ForeignKey(VehicleClass)
    is_available = BooleanField(default=True)
```

---

## Dependencies

### Depends On
- Модель `Booking` (существует)
- Модель `User` с ролями (существует)
- Django REST Framework (установлен)
- JWT аутентификация (настроена)
- Sales Report Dashboard (reference для Streamlit)

### Will Affect
- API endpoints (новые для диспетчера)
- Django Admin (можно оставить для суперадмина)
- Модель Booking (новые поля)
- Возможно Flutter app (отображение назначенного водителя)

---

## Recommended Approach

### Фаза 1: Backend API
1. Добавить поля в модель Booking (driver assignment, cancellation)
2. Создать DriverProfile модель или расширить User
3. Создать ViewSet для управления бронированиями диспетчером
4. Добавить endpoints: список всех бронирований, смена статуса, назначение водителя
5. Endpoint для статистики/KPI
6. Написать тесты

### Фаза 2: Flutter iPad App (MVP)
1. Создать модуль `dispatcher/` в существующем Flutter проекте
2. Реализовать Master-Detail layout для iPad
3. Создать экран списка бронирований с фильтрами
4. Добавить экран деталей с быстрыми действиями
5. Реализовать назначение водителя
6. Добавить формы создания/редактирования

### Фаза 3: Улучшения (Post-MVP)
1. Календарный вид (table_calendar)
2. KPI dashboard с графиками (fl_chart)
3. Push-уведомления о новых бронированиях
4. Offline режим

---

## Technology Decision

### Рекомендация: Flutter iPad App

| За Flutter | Против |
|------------|--------|
| ✅ Единый стек с клиентским приложением | ❌ Требует отдельной сборки для iPad |
| ✅ Переиспользование моделей, провайдеров, API клиента | ❌ Дополнительное время на iPad-специфичный UI |
| ✅ Нативный iOS experience (Cupertino) | |
| ✅ Offline capabilities | |
| ✅ Master-Detail pattern идеален для iPad | |

### Архитектура приложения

```
frontend/lib/
├── presentation/
│   └── screens/
│       └── dispatcher/           # NEW: Диспетчер модуль
│           ├── dispatcher_home_screen.dart    # Master-Detail layout
│           ├── booking_list_view.dart         # Список бронирований
│           ├── booking_detail_view.dart       # Детали бронирования
│           ├── booking_edit_screen.dart       # Редактирование
│           ├── booking_create_screen.dart     # Создание
│           ├── dispatcher_stats_screen.dart   # KPI
│           └── widgets/
│               ├── booking_list_tile.dart
│               ├── status_badge.dart
│               ├── driver_picker.dart
│               └── quick_actions.dart
│   └── providers/
│       └── dispatcher/           # NEW: Провайдеры диспетчера
│           ├── dispatcher_bookings_provider.dart
│           ├── drivers_provider.dart
│           └── dispatcher_stats_provider.dart
```

### iPad-специфичные особенности

| Особенность | Реализация |
|-------------|------------|
| **Master-Detail** | `Row` с `Expanded` для списка и деталей |
| **Landscape/Portrait** | `OrientationBuilder` для адаптивного layout |
| **Большой экран** | Больше информации на одном экране |
| **Keyboard shortcuts** | Быстрые действия с клавиатуры |
| **Drag & Drop** | Назначение водителя перетаскиванием (future) |

---

# Инструкции для нового сотрудника (Диспетчера)

## Общие сведения

**Должность:** Диспетчер трансферов
**Основная задача:** Управление всеми процессами бронирования трансферов от заказа до завершения
**Рабочее устройство:** iPad с установленным приложением диспетчера

## Начало работы

### Первый вход
1. Получить iPad с предустановленным приложением
2. Открыть приложение "Transfer Dispatcher"
3. Войти с предоставленными учётными данными (email + пароль)
4. Ознакомиться с интерфейсом

### Интерфейс приложения
- **Левая панель:** Список бронирований с фильтрами
- **Правая панель:** Детали выбранного бронирования
- **Нижняя навигация:** Бронирования | Календарь | Статистика | Настройки

## Ежедневные обязанности

### Начало смены
1. Открыть приложение на iPad
2. Проверить все бронирования на сегодня (фильтр "Сегодня")
3. Убедиться, что все трансферы назначены водителям
4. Проверить статусы оплаты

### В течение смены
1. Мониторить новые бронирования (статус PENDING) — они подсвечены
2. Подтверждать бронирования (PENDING → CONFIRMED)
3. Назначать водителей на трансферы
4. Обновлять статусы по мере выполнения
5. Обрабатывать звонки и создавать ручные заказы

### Конец смены
1. Проверить выполнение всех трансферов за день
2. Отметить завершённые (COMPLETED)
3. Передать информацию о проблемах следующей смене

## Статусы бронирований

| Статус | Значение | Когда ставить |
|--------|----------|---------------|
| `PENDING` | Ожидает подтверждения | Новый заказ |
| `CONFIRMED` | Подтверждено | После проверки данных и назначения водителя |
| `IN_PROGRESS` | Трансфер выполняется | Водитель выехал/встретил клиента |
| `COMPLETED` | Завершено | Клиент доставлен |
| `CANCELLED` | Отменено | По запросу клиента или форс-мажор |

## Статусы оплаты

| Статус | Значение |
|--------|----------|
| `UNPAID` | Не оплачено |
| `DEPOSIT_PAID` | Депозит внесён |
| `FULLY_PAID` | Полностью оплачено |
| `REFUNDED` | Возврат выполнен |

## Workflow обработки заказа

```
1. Новый заказ (PENDING)
   ↓
2. Проверить данные (адреса, время, контакты)
   ↓
3. Назначить водителя
   ↓
4. Подтвердить (CONFIRMED)
   ↓
5. В день трансфера:
   - Водитель выехал → IN_PROGRESS
   - Клиент доставлен → COMPLETED
```

## Обработка отмен

1. Получить запрос на отмену от клиента
2. Проверить политику возврата (зависит от времени до трансфера)
3. Изменить статус на CANCELLED
4. Указать причину отмены
5. При необходимости инициировать возврат (REFUNDED)

## Создание ручного заказа

При телефонном звонке:
1. Нажать "Создать бронирование"
2. Заполнить:
   - Откуда (pickup address)
   - Куда (dropoff address)
   - Дата и время
   - Количество пассажиров
   - Багаж
   - Класс машины
   - Контакты клиента
3. Сохранить и назначить водителя

## Классы машин

| Класс | Пассажиры | Багаж | Когда использовать |
|-------|-----------|-------|-------------------|
| Economy Sedan | 1-3 | 2 маленьких | Одиночные поездки |
| Business Sedan | 1-3 | 2 средних | Бизнес-клиенты |
| Luxury Sedan | 1-3 | 2 средних | VIP |
| Minivan | 4-6 | 4-6 | Семьи |
| Luxury Minivan | 4-6 | 4-6 | VIP группы |
| Minibus | 7-12 | 8-12 | Группы |
| Large Minibus | 13-19 | 15+ | Большие группы |

## Ценообразование

Финальная цена = Базовая × Класс × Сезон × Пассажиры × Время + Доп.услуги

### Сезонные коэффициенты
- **High Summer (15.06-15.09):** ×1.30
- **Shoulder Season (01.04-14.06):** ×1.15
- **Low Season (01.11-31.03):** ×1.00
- **Ferragosto (10-20.08):** ×1.40

### Временные коэффициенты
- **Late Night (22:00-06:00):** ×1.20
- **Early Morning (05:00-07:00):** ×1.25

### Дополнительные услуги
- Детское кресло (0-4 года): €10
- Бустер (4-12 лет): €5
- Крупный багаж: €15/шт
- Перевозка питомца: €20
- Ожидание: €30/час

## Контакты для эскалации

| Ситуация | Действие |
|----------|----------|
| Технические проблемы | Связаться с разработчиком |
| Жалобы клиентов | Передать менеджеру |
| ДТП или ЧП | Немедленно сообщить руководству |
| Вопросы по оплате | Бухгалтерия |

## FAQ

**Q: Что делать, если водитель не отвечает?**
A: Попробовать связаться 3 раза с интервалом 5 минут. Если не отвечает - назначить другого водителя и сообщить менеджеру.

**Q: Можно ли изменить цену после подтверждения?**
A: Только с согласия клиента и фиксацией причины в заметках.

**Q: Что делать при опоздании рейса клиента?**
A: Отслеживать рейс по номеру, информировать водителя. Ожидание до 1 часа бесплатно.

**Q: Как обрабатывать Round Trip?**
A: Оба трансфера создаются как одно бронирование. Скидка 10% применяется автоматически.

---

*Документ создан: 2026-01-22*
*Версия: 1.0*
